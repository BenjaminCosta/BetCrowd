rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUserDoc(userId) {
      return request.auth.uid == userId;
    }
    
    function getTournamentRole(tournamentId) {
      return get(/databases/$(database)/documents/tournaments/$(tournamentId)/members/$(request.auth.uid)).data.role;
    }
    
    function isTournamentMember(tournamentId) {
      return exists(/databases/$(database)/documents/tournaments/$(tournamentId)/members/$(request.auth.uid));
    }
    
    function isTournamentAdmin(tournamentId) {
      let role = getTournamentRole(tournamentId);
      return role == 'owner' || role == 'admin';
    }
    
    function isTournamentOwner(tournamentId) {
      return get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.ownerId == request.auth.uid;
    }

    // ===================================
    // USER PROFILES
    // ===================================
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && isUserDoc(userId);
      
      // Users can create and update their own profile
      allow create, update: if isAuthenticated() && isUserDoc(userId);
      
      // No one can delete user profiles
      allow delete: if false;
    }

    // ===================================
    // TOURNAMENTS
    // ===================================
    match /tournaments/{tournamentId} {
      // Anyone authenticated can read tournament (for join via code)
      allow read: if isAuthenticated();
      
      // Only authenticated users can create tournaments
      allow create: if isAuthenticated() 
        && request.resource.data.ownerId == request.auth.uid;
      
      // Only owner can update or delete tournament
      allow update, delete: if isAuthenticated() 
        && isTournamentOwner(tournamentId);

      // Members subcollection
      match /members/{userId} {
        // Anyone in tournament can read members
        allow read: if isAuthenticated() && isTournamentMember(tournamentId);
        
        // Users can join tournament (create their own member doc)
        allow create: if isAuthenticated() && isUserDoc(userId);
        
        // Owner/admin can update member roles
        // Users can update their own member doc (but not role)
        allow update: if isAuthenticated() && (
          isTournamentAdmin(tournamentId) ||
          (isUserDoc(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
        );
        
        // Owner/admin can remove members
        allow delete: if isAuthenticated() && isTournamentAdmin(tournamentId);
      }

      // ===================================
      // EVENTS
      // ===================================
      match /events/{eventId} {
        // Any tournament member can read events
        allow read: if isAuthenticated() && isTournamentMember(tournamentId);
        
        // Only owner/admin can create, update, or delete events
        allow create, update, delete: if isAuthenticated() && isTournamentAdmin(tournamentId);
        
        // ===================================
        // BETS
        // ===================================
        match /bets/{betId} {
          // Any tournament member can read bets
          allow read: if isAuthenticated() && isTournamentMember(tournamentId);
          
          // Only owner/admin can create, update, or delete bets
          allow create, update, delete: if isAuthenticated() && isTournamentAdmin(tournamentId);
          
          // ===================================
          // PICKS (User predictions on bets)
          // ===================================
          match /picks/{userId} {
            // Any tournament member can read picks
            allow read: if isAuthenticated() && isTournamentMember(tournamentId);
            
            // Users can only create/update/delete their own picks
            // AND bet must be in "open" status (check in client)
            allow create, update, delete: if isAuthenticated() 
              && isUserDoc(userId)
              && isTournamentMember(tournamentId);
          }
        }
      }

      // ===================================
      // PREDICTIONS (Legacy - if you have these)
      // ===================================
      match /predictions/{predictionId} {
        // Any tournament member can read predictions
        allow read: if isAuthenticated() && isTournamentMember(tournamentId);
        
        // Users can create their own predictions
        allow create: if isAuthenticated() 
          && isTournamentMember(tournamentId)
          && request.resource.data.userId == request.auth.uid;
        
        // Users can update/delete their own predictions
        // Owner/admin can update any prediction (for scoring)
        allow update, delete: if isAuthenticated() && (
          (isTournamentMember(tournamentId) && resource.data.userId == request.auth.uid) ||
          isTournamentAdmin(tournamentId)
        );
      }

      // ===================================
      // STANDINGS (Read-only for members, write for admin)
      // ===================================
      match /standings/{standingId} {
        // Any tournament member can read standings
        allow read: if isAuthenticated() && isTournamentMember(tournamentId);
        
        // Only owner/admin can create, update, or delete standings
        allow create, update, delete: if isAuthenticated() && isTournamentAdmin(tournamentId);
      }

      // ===================================
      // NOTIFICATIONS
      // ===================================
      match /notifications/{notificationId} {
        // Users can only read their own notifications
        allow read: if isAuthenticated() 
          && resource.data.userId == request.auth.uid;
        
        // Owner/admin can create notifications
        allow create: if isAuthenticated() && isTournamentAdmin(tournamentId);
        
        // Users can update/delete their own notifications (mark as read, etc.)
        allow update, delete: if isAuthenticated() 
          && resource.data.userId == request.auth.uid;
      }

      // ===================================
      // CHAT/COMMENTS (Optional - if you add these)
      // ===================================
      match /comments/{commentId} {
        // Any tournament member can read comments
        allow read: if isAuthenticated() && isTournamentMember(tournamentId);
        
        // Any tournament member can create comments
        allow create: if isAuthenticated() 
          && isTournamentMember(tournamentId)
          && request.resource.data.userId == request.auth.uid;
        
        // Users can update/delete their own comments
        // Owner/admin can delete any comment (moderation)
        allow update: if isAuthenticated() 
          && resource.data.userId == request.auth.uid;
        
        allow delete: if isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          isTournamentAdmin(tournamentId)
        );
      }
    }

    // ===================================
    // GLOBAL LEADERBOARD (Optional)
    // ===================================
    match /leaderboard/{userId} {
      // Anyone can read leaderboard
      allow read: if isAuthenticated();
      
      // No one can write directly (use Cloud Functions)
      allow write: if false;
    }

    // ===================================
    // APP SETTINGS (Read-only for users)
    // ===================================
    match /settings/{settingId} {
      // Anyone can read settings
      allow read: if isAuthenticated();
      
      // No one can write (admin only via console/functions)
      allow write: if false;
    }

    // Default deny all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
