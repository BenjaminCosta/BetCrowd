rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isMe(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isTournamentMember(tournamentId) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/tournaments/$(tournamentId)/members/$(request.auth.uid));
    }

    function isTournamentOwner(tournamentId) {
      return isSignedIn() &&
        get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.ownerId == request.auth.uid;
    }

    // -------------------------
    // USERS
    // -------------------------
    match /users/{userId} {
      allow read: if isMe(userId);

      allow create, update: if isMe(userId)
        && request.resource.data.uid == request.auth.uid;

      allow delete: if false;

      // Subcolección: tournamentRefs
      match /tournamentRefs/{tournamentId} {
        allow read: if isMe(userId);

        // ✅ FIX: Remove tournamentId requirement (it's the doc ID)
        allow create, update: if isMe(userId)
          && request.resource.data.keys().hasAll(["role", "joinedAt"]);

        allow delete: if isMe(userId);
      }
    }

    // -------------------------
    // USERNAMES (unique claim)
    // -------------------------
    match /usernames/{username} {
      allow read: if isSignedIn();

      allow create: if isSignedIn()
        && request.resource.data.keys().hasAll(["uid"])
        && request.resource.data.uid == request.auth.uid;

      allow update: if false;

      allow delete: if isSignedIn()
        && resource.data.uid == request.auth.uid;
    }

    // -------------------------
    // INVITE CODES (index)
    // ✅ FIX: Allow delete by owner
    // -------------------------
    match /inviteCodes/{code} {
      allow read: if isSignedIn();

      // ✅ FIX: Don't require createdAt in hasOnly (serverTimestamp not in request.resource)
      allow create: if isSignedIn()
        && request.resource.data.keys().hasAll(["tournamentId", "ownerId"])
        && request.resource.data.ownerId == request.auth.uid;

      allow update: if false;
      
      // ✅ FIX: Allow owner to delete their invite codes
      allow delete: if isSignedIn()
        && resource.data.ownerId == request.auth.uid;
    }

    // -------------------------
    // TOURNAMENTS
    // ✅ FIX: Remove hasOnly validation to allow null fields
    // -------------------------
    match /tournaments/{tournamentId} {

      allow create: if isSignedIn()
        && request.resource.data.ownerId == request.auth.uid
        && request.resource.data.keys().hasAll([
          "name",
          "format",
          "contribution",
          "participantsEstimated",
          "ownerId",
          "inviteCode",
          "status"
        ]);

      // ✅ Read if member
      allow read: if isTournamentMember(tournamentId);

      // ✅ Update only owner
      allow update: if isTournamentOwner(tournamentId);

      allow delete: if false;

      // MEMBERS
      match /members/{uid} {
        allow read: if isTournamentMember(tournamentId);

        // ✅ FIX: Don't require hasOnly (serverTimestamp issue)
        allow create: if isSignedIn()
          && (isTournamentOwner(tournamentId) || request.auth.uid == uid)
          && request.resource.data.keys().hasAll(["role"])
          && request.resource.data.role in ["owner", "admin", "member"];

        allow update, delete: if isTournamentOwner(tournamentId);
      }

      // EVENTS
      match /events/{eventId} {
        allow read: if isTournamentMember(tournamentId);
        allow create, update, delete: if isTournamentOwner(tournamentId);
      }

      // PREDICTIONS / PICKS
      match /predictions/{predictionId} {
        allow read: if isTournamentMember(tournamentId);

        allow create: if isTournamentMember(tournamentId)
          && request.resource.data.userId == request.auth.uid;

        allow update, delete: if isTournamentMember(tournamentId)
          && resource.data.userId == request.auth.uid;
      }
    }

    // -------------------------
    // DENY BY DEFAULT
    // -------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
